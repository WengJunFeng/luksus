#!/usr/bin/env bash
# LUKSUS
# Easy drive encryption script using LUKS
# by Thomas Frivold
#
# github code repository (project page):
# https://github.com/thomasfrivold/luksus
#
# please see README file for complete information
# regarding LUKSUS
# 
# LUKSUS is released under GNU GPLv2 License
# see URL below
# http://www.gnu.org/licenses/gpl-2.0.html 

###############################
######### VARIABLES ###########
###############################

if [ -r LUKSUS.variables ]; then
	source LUKSUS.variables
else
	exit 1
fi

###############################
#####    FUNCTIONS       ######
###############################


if [ -r LUKSUS.functions ]; then
	source LUKSUS.functions
else
	exit 1
fi


###############################
###### INITIAL WELCOME ########
###############################

if [ -r LUKSUS.welcome ]; then
	source LUKSUS.welcome
else
	exit 1
fi


###############################
##### CONDITIONAL CHECKS ######
###############################


if [ -r LUKSUS.checks ]; then
	source LUKSUS.checks
else
	exit 1
fi


#########################################################
#########################################################
#########################################################
#########################################################
################ BEGINNING PROGRAM ######################
#########################################################
#########################################################
#########################################################
#########################################################

trap 'exithousekeeping'  EXIT     # calls deletetempfiles function on exit


# Calling functions
DISPLAYLOGO
OSTEST

# MENUSYSTEM - USER INTERACTION
GRAPHICALWELCOME
WELCOMEINFORMATION
WIZARD
MENUSYSTEM
GRAPHICALVERIFYCHOICES
ASKUSERVERIFYCONSOLE
# PREPARE KEYFILE
CREATEKEYFILE

# LOOP DEVICE FUNCTIONS AND HOUSEKEEPING
LOOPBACKTEST
DRAGONFLYHOUSEKEEPING
FREEBSDHOUSEKEEPING
NETBSDHOUSEKEEPING

###############################
######### VARIABLES RE-INITIALIZATION  ###########
# maybe not necessary # it probably resets runtime variables and fucks everything up
###############################

#if [ -r LUKSUS.variables ]; then
#	source LUKSUS.variables
#else
#	exit 1
#fi

# THE STUFF BELOW REQUIRES STABLE RUNTIME VARIABLES
# NOTE TO SELF - DON'T LET USER CHANGE ANYTHING BELOW HERE

# BEGIN PROGRAM
LOOPBACKMETHOD
DEVICEEXISTS
DONTSHREDIFLOOPBACK

# ENCRYPTION PHASE #

# TRUECRYPT PROCESS
TRUECRYPT
TRUECRYPTKEYFILE
TRUECRYPTOPEN

# LUKS PROCESS
LUKS
LUKSKEYFILE
LUKSVERIFY
LUKSOPEN

# GELI PROCESS
GELI
GELIKEYFILE
GELIOPEN

# CGD PROCESS COMING SOON
# CGD
# CGDKEYFILE
# CGDOPEN

# BIOCTL PROCESS MIGHT BE COMING SOON
# BIOCTL
# BIOCTLKEYFILE
# BIOCTLOPEN

# CREATING THE FILESYSTEM AND MOUNTING IT
CREATEANDMOUNTFS

# END PROGRAM
DISPLAYLOGO
echo The data below can also be found in /keys/$name.information
DISPLAYSUMMARY
WRITEINFORMATIONFILE
HOUSECLEANING
exit 0
