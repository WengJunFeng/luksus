#!/usr/bin/env bash
# LUKSUS by Thomas Frivold
#
# github code repository (project page):
# https://github.com/thomasfrivold/luksus
#
# fancy website:
# http://thomasfrivold.github.io/luksus
#
# please see README file for complete information
# regarding LUKSUS
# 
# LUKSUS is released under GNU GPLv2 License
# see URL http://www.gnu.org/licenses/gpl-2.0.html 

###############################
######### VARIABLES ###########
###############################

if [ -r LUKSUS.variables ]; then
	source LUKSUS.variables
else
	exit 1
fi

###############################
#####    FUNCTIONS       ######
###############################


if [ -r LUKSUS.functions ]; then
	source LUKSUS.functions
else
	exit 1
fi


###############################
###### INITIAL WELCOME ########
###############################

if [ -r LUKSUS.welcome ]; then
	source LUKSUS.welcome
else
	exit 1
fi


###############################
##### CONDITIONAL CHECKS ######
###############################


if [ -r LUKSUS.checks ]; then
	source LUKSUS.checks
else
	exit 1
fi

###############################
########## DEBUG ##############
###############################
# CALLING DEBUG FUNCTION FROM #
# ITS OWN SOURCE, SINCE THE   #
# MAIN FUNCTIONS FILE EASILY  #
# BREAK WHEN THINGS ARE ADDED #
###############################
if [ -r LUKSUS.debug ]; then
	source LUKSUS.debug
else
	exit 1
fi



#########################################################
#########################################################
#########################################################
#########################################################
################ BEGINNING PROGRAM ######################
#########################################################
#########################################################
#########################################################
#########################################################

trap 'exithousekeeping'  EXIT     # calls housekeeping function on exit. Will be run once for errorlevel 0 and once for every errorlevel 1. awesome.

# Calling functions
DEBUGSTEP
DISPLAYLOGO
DEBUGSTEP
OSTEST

# MENUSYSTEM - USER INTERACTION
DEBUGSTEP
GRAPHICALWELCOME
DEBUGSTEP
WELCOMEINFORMATION
DEBUGSTEP
WIZARD
DEBUGSTEP
MENUSYSTEM
DEBUGSTEP
ASKUSERVERIFYCONSOLE # safety check. To be sure.

# PREPARE KEYFILE
DEBUGSTEP
CREATEKEYFILE

# LOOP DEVICE FUNCTIONS AND HOUSEKEEPING
DEBUGSTEP
LOOPBACKTEST
DEBUGSTEP
DRAGONFLYHOUSEKEEPING
DEBUGSTEP
FREEBSDHOUSEKEEPING
DEBUGSTEP
NETBSDHOUSEKEEPING

# THE STUFF BELOW REQUIRES STABLE RUNTIME VARIABLES
# NOTE TO SELF - DON'T LET USER CHANGE ANY VARIABLES BELOW HERE

# BEGIN PROGRAM
DEBUGSTEP
LOOPBACKMETHOD
DEBUGSTEP
DEVICEEXISTS
DEBUGSTEP
DONTSHREDIFLOOPBACK

### ENCRYPTION PHASE ###

# TRUECRYPT PROCESS
DEBUGSTEP
TRUECRYPT
DEBUGSTEP
TRUECRYPTKEYFILE
DEBUGSTEP
TRUECRYPTOPEN

# LUKS PROCESS
DEBUGSTEP
LUKS
DEBUGSTEP
LUKSKEYFILE
DEBUGSTEP
LUKSVERIFY
DEBUGSTEP
LUKSOPEN

# GELI PROCESS
DEBUGSTEP
GELI
DEBUGSTEP
GELIKEYFILE
DEBUGSTEP
GELIOPEN

# CGD PROCESS COMING SOON FOR NETBSD SUPPORT
# CGD
# CGDKEYFILE
# CGDOPEN

# BIOCTL PROCESS MIGHT BE COMING SOON FOR OPENBSD SUPPORT
# BIOCTL
# BIOCTLKEYFILE
# BIOCTLOPEN

# OPENPGPCTL PROCESS MIGHT BE COMING SOON FOR PGP SUPPORT
# OPENPGP
# OPENPGPKEYFILE
# OPENPGPOPEN

# CREATING THE FILESYSTEM AND MOUNTING IT
DEBUGSTEP
CREATEANDMOUNTFS

# END PROGRAM
DEBUGSTEP
DISPLAYLOGO
DEBUGSTEP
echo The data below can also be found in /keys/$name.information
DISPLAYSUMMARY
DEBUGSTEP
DISPLAYSUMMARYGRAPHICAL
DEBUGSTEP
WRITEINFORMATIONFILE
exit 0
